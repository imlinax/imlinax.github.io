---
layout: post
title: redis 使用疑问
tag: redis
---

在redis的使用过程中，遇到了下面几个问题尚未得到解决，留待以后解决。
1. redis server进程 cpu使用率达到300%。
前提：
我们在生产环境中同时启用了rdb和aof持久化。
解答：
众所周知，redis 是一个"单进程单线程"的缓存数据库，好像不应该出现CPU300%的情况,但是既然出现了300%，不是top出了问题，就一定是存在多个线程。
事实上，redis既不是单进程的，也不是单线程的。
那为什么大家都在说它是单进程单线程的服务呢，那是因为它的主要工作都是在一个单线程的eventloop中完成，无论是命令(GET/SET/LRAGE/xxx)解析还是执行都是这个线程中运行。
问：那什么时候出现了多进程呢，
答： 持久化aof和rdb的时候， redis-server会fork一个进程进行持久化，借助父子进程的COW功能，利用最小的代价，完成了数据的快照，然后在子进程中完成持久化。
问：那什么时候出现了多线程呢？
答： redis有一个模块叫做backgroud job ,即后台任务。redis会创建两个线程去执行后台任务，目前后台任务只包含了AOF文件的fclose和fsync。

其实说到这里问题基本清楚了，redis目前非常繁忙，主线程将单个核心占满了，同时由于开启了aof，两个后台任务线程也分别达到了100%的CPU占用。不过至今令我疑惑的是，fclose和fsync居然也能将单个CPU核心跑满。


2. redis-cli支持--rdb的方式将redis的数据以rdb的形式备份到本地，为什么不支持--rdb的方式恢复数据？